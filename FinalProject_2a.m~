% Script: convect1d.m
clear all;

%set constants
v_max = 33;     % m/s
p_max = 0.25;   % 1/m
p_L = 0.15;     % Left boundary density
p_R = 0.25;     % Right boundary density

% Set-up grid
xL = 0;
xR = 2000;
Nx = 100;       % number of cells
x = linspace(xL,xR,Nx+1);

% Calculate midpoint of each cell. 
xmid = zeros(1,Nx);
for i = 1:1:Nx
    xmid(i) = (.5)*(x(i) + x(i+1));
end % for i = 1:1:Nx

% Calculate cell size. We assume that each cell is the same size
dx = x(2) - x(1);

% Set shock velocity
a = ((1-p_L/p_max)*v_max*p_L - (1-p_R/p_max)*v_max*p_R)/(p_L-p_R);

% Set final time
tfinal = 35;

% Set timestep
CFL = 0.5;
dt = CFL*dx/v_max;
t=0;

% Set initial condition to p0 = 0.15 (1/m)
P = zeros(1,numel(xmid));       % Density in each cell
for i = 1:1:numel(xmid)
    P(i) = .15;
end % for i = 1:1:numel(xmid)

% Initialize exact solution array
P_Exact=zeros(size(P));         % Exact density in each cell (at midpoints)

% Loop until t > tfinal
while (t < tfinal)
    Pbc = [p_L, P, p_R]; % This enforces the bc
    
    % Calculate the flux at each interface
    %Pbc_avg = 0.5*(Pbc(1:Nx+1)+Pbc(2:Nx+2));
    n_Pbc = numel(Pbc);             % Get number of elements.
    
    Flux_R_Bound = zeros(1,n_Pbc);
    for i = 1:1:n_Pbc
        Flux_R_Bound(i) = (1-Pbc(i)/p_max)*v_max*Pbc(i);
    end % for i = 1:1:n_Pbc
    
    % Find net flux in each cell
    Net_Flux = zeros(1,Nx+2);
    for i = 2:1:(Nx+2)
        Net_Flux(i) = Flux_R_Bound(i-1) - Flux_R_Bound(i);
        % for the ith cell, cars come in from the left and out through the
        % right. However, the left boundary of the ith cell is the right
        % boundary of the i+1th cell. Thus, to get the left flux, we simply
        % find the right boundary flux for the i-1th cell (which is stored
        % in the i-1th element of Flux_R_Bound). 
        % 
        % Further note that there is no right boundary for the 1st cell.
        % This is because we never found the flux for the left most cell of
        % Pbc. This boundary corresdonds to the left boundary of the Left
        % BC cell. We don't care about the flux in this cell, since P in
        % the boundary cells is constant. Thus, the index in this for loop
        % only goes from 2 to Nx+2, not 1 to Nx+2 (there are Nx+2 cells in
        % Pbc, the final cell corresponds to the right BC cell). 
    end % for i = 1:1:(n_Pbc-1)
    
    % Update P for all interior elements of Pbc
    for i = 2:1:(Nx+2)
        P(i-1) = P(i-1) + Net_Flux(i)*(dt/dx);
    end % for i = 2:1:(Nx+2)

    %calculate exact solution at this time step
        for i=1:length(P_Exact)
            if ((dx*(i-1/2))-2000)/t < a
                P_Exact(i) = p_L;
            else
                P_Exact(i) = p_R;
            end
        end

    % Increment time
    t = t + dt;

    % Plot current solution
    figure(1)
    clf
    plot(x,[P, P(Nx)],'go');
    hold on;
    plot(x,[P_Exact, P_Exact(Nx)],'k-');
    axis([xL, xR, 0, 0.3]);
    legend('FVM','Exact');
    title(['t=',num2str(t)]);
    ylabel('density (1/m)');
    xlabel('distance (m)');
    grid on;
    drawnow;
    hold off;
end % while(t < tfinal)
